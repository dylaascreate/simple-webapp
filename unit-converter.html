<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unit Converter</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Use Inter as the default font */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for number input to hide spinners */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 flex items-center justify-center h-full p-4">

    <div class="w-full max-w-md bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 sm:p-8">
        <h1 class="text-2xl sm:text-3xl font-bold text-center text-gray-800 dark:text-white mb-6">
            Unit Converter
        </h1>

        <!-- Category Selector -->
        <div class="mb-6">
            <label for="category" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Category</label>
            <select id="category" name="category" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                <option value="length">Length</option>
                <option value="weight">Weight</option>
                <option value="temperature">Temperature</option>
                <option value="area">Area</option>
                <option value="volume">Volume</option>
            </select>
        </div>

        <div class="flex flex-col sm:flex-row items-center justify-between space-y-4 sm:space-y-0 sm:space-x-4">
            
            <!-- From Section -->
            <div class="w-full">
                <label for="from-unit" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">From</label>
                <input type="number" id="from-value" value="1" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 mb-2" placeholder="Enter value">
                <select id="from-unit" name="from-unit" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                    <!-- Options will be populated by JS -->
                </select>
            </div>

            <!-- Swap Button -->
            <div class="flex-shrink-0 pt-6">
                <button id="swap-btn" class="p-2 rounded-full bg-blue-600 text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-900 transition-transform duration-200 ease-in-out sm:rotate-0 rotate-90">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M7 16V4m0 12l-4-4m4 4l4-4m6 8v-12m0 12l4-4m-4 4l-4-4" />
                    </svg>
                </button>
            </div>

            <!-- To Section -->
            <div class="w-full">
                <label for="to-unit" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">To</label>
                <input type="number" id="to-value" class="w-full bg-gray-200 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg block p-2.5 mb-2" placeholder="Result" readonly>
                <select id="to-unit" name="to-unit" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                    <!-- Options will be populated by JS -->
                </select>
            </div>
        </div>

        <!-- ✨ Gemini Feature Section -->
        <div class="mt-6 text-center">
            <button id="gemini-btn" class="w-full sm:w-auto inline-flex items-center justify-center px-6 py-3 bg-gradient-to-r from-purple-500 to-blue-600 hover:from-purple-600 hover:to-blue-700 text-white font-semibold rounded-lg shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 disabled:opacity-50 disabled:cursor-not-allowed">
                <!-- Sparkle Icon -->
                <svg id="sparkle-icon" class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m1-15h.01M21 12h-0.01M12 21v-0.01M3 12h.01M21 3l-1.4 1.4M4.4 19.6L3 21m18-18l-1.4 1.4M19.6 4.4L21 3m-1.4 15.2l1.4 1.4m-1.4-1.4l1.4-1.4m-18 1.4l1.4-1.4m1.4 1.4L3 19.6" />
                </svg>
                <!-- Loading Spinner (hidden by default) -->
                <svg id="loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span id="gemini-btn-text">✨ Get Real-World Context</span>
            </button>
        </div>

        <!-- Gemini Result Display -->
        <div id="gemini-result-container" class="mt-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg text-gray-700 dark:text-gray-200 text-sm leading-relaxed hidden">
            <p id="gemini-result-text"></p>
        </div>
        <!-- End Gemini Feature Section -->

    </div>

    <script>
        const categorySelect = document.getElementById('category');
        const fromValueInput = document.getElementById('from-value');
        const fromUnitSelect = document.getElementById('from-unit');
        const toValueInput = document.getElementById('to-value');
        const toUnitSelect = document.getElementById('to-unit');
        const swapButton = document.getElementById('swap-btn');
        // --- Add new element selectors ---
        const geminiButton = document.getElementById('gemini-btn');
        const geminiButtonText = document.getElementById('gemini-btn-text');
        const geminiResultContainer = document.getElementById('gemini-result-container');
        const geminiResultText = document.getElementById('gemini-result-text');
        const sparkleIcon = document.getElementById('sparkle-icon');
        const loadingSpinner = document.getElementById('loading-spinner');
        // --- End of new selectors ---

        // Define units for each category
        const units = {
            length: {
                name: "Length",
                units: {
                    meter: { name: "Meter", factor: 1 },
                    centimeter: { name: "Centimeter", factor: 0.01 },
                    millimeter: { name: "Millimeter", factor: 0.001 },
                    kilometer: { name: "Kilometer", factor: 1000 },
                    inch: { name: "Inch", factor: 0.0254 },
                    foot: { name: "Foot", factor: 0.3048 },
                    yard: { name: "Yard", factor: 0.9144 },
                    mile: { name: "Mile", factor: 1609.34 }
                },
                defaults: ['inch', 'centimeter']
            },
            weight: {
                name: "Weight",
                units: {
                    gram: { name: "Gram", factor: 1 },
                    kilogram: { name: "Kilogram", factor: 1000 },
                    milligram: { name: "Milligram", factor: 0.001 },
                    pound: { name: "Pound (lb)", factor: 453.592 },
                    ounce: { name: "Ounce (oz)", factor: 28.3495 }
                },
                defaults: ['pound', 'kilogram']
            },
            temperature: {
                name: "Temperature",
                units: {
                    celsius: { name: "Celsius" },
                    fahrenheit: { name: "Fahrenheit" },
                    kelvin: { name: "Kelvin" }
                },
                defaults: ['celsius', 'fahrenheit']
            },
            area: {
                name: "Area",
                units: {
                    sq_meter: { name: "Square Meter", factor: 1 },
                    sq_kilometer: { name: "Square Kilometer", factor: 1e6 },
                    sq_centimeter: { name: "Square Centimeter", factor: 1e-4 },
                    sq_millimeter: { name: "Square Millimeter", factor: 1e-6 },
                    hectare: { name: "Hectare", factor: 10000 },
                    sq_mile: { name: "Square Mile", factor: 2.59e6 },
                    sq_yard: { name: "Square Yard", factor: 0.836127 },
                    sq_foot: { name: "Square Foot", factor: 0.092903 },
                    sq_inch: { name: "Square Inch", factor: 0.00064516 },
                    acre: { name: "Acre", factor: 4046.86 }
                },
                defaults: ['sq_foot', 'sq_meter']
            },
            volume: {
                name: "Volume",
                units: {
                    liter: { name: "Liter", factor: 1 },
                    milliliter: { name: "Milliliter", factor: 0.001 },
                    cubic_meter: { name: "Cubic Meter", factor: 1000 },
                    cubic_centimeter: { name: "Cubic Centimeter", factor: 0.001 },
                    gallon_us: { name: "Gallon (US)", factor: 3.78541 },
                    quart_us: { name: "Quart (US)", factor: 0.946353 },
                    pint_us: { name: "Pint (US)", factor: 0.473176 },
                    cup_us: { name: "Cup (US)", factor: 0.24 }, // Using 240mL cup
                    fluid_ounce_us: { name: "Fluid Ounce (US)", factor: 0.0295735 },
                    tablespoon_us: { name: "Tablespoon (US)", factor: 0.0147868 },
                    teaspoon_us: { name: "Teaspoon (US)", factor: 0.00492892 }
                },
                defaults: ['gallon_us', 'liter']
            }
        };

        // Function to populate unit dropdowns based on selected category
        function populateUnits() {
            const category = categorySelect.value;
            const unitData = units[category];
            
            fromUnitSelect.innerHTML = '';
            toUnitSelect.innerHTML = '';

            for (const unitKey in unitData.units) {
                const unitName = unitData.units[unitKey].name;
                
                const fromOption = document.createElement('option');
                fromOption.value = unitKey;
                fromOption.textContent = unitName;
                fromUnitSelect.appendChild(fromOption);

                const toOption = document.createElement('option');
                toOption.value = unitKey;
                toOption.textContent = unitName;
                toUnitSelect.appendChild(toOption);
            }

            // Set default selections
            fromUnitSelect.value = unitData.defaults[0];
            toUnitSelect.value = unitData.defaults[1];

            convert(); // Perform initial conversion
        }

        // Function to perform the conversion
        function convert() {
            const fromValue = parseFloat(fromValueInput.value);
            const fromUnit = fromUnitSelect.value;
            const toUnit = toUnitSelect.value;
            const category = categorySelect.value;

            if (isNaN(fromValue)) {
                toValueInput.value = '';
                return;
            }

            let result;
            const unitData = units[category];

            // Special handling for temperature
            if (category === 'temperature') {
                if (fromUnit === toUnit) {
                    result = fromValue;
                }
                // Celsius to ...
                else if (fromUnit === 'celsius') {
                    if (toUnit === 'fahrenheit') {
                        result = (fromValue * 9/5) + 32;
                    } else if (toUnit === 'kelvin') {
                        result = fromValue + 273.15;
                    }
                }
                // Fahrenheit to ...
                else if (fromUnit === 'fahrenheit') {
                    if (toUnit === 'celsius') {
                        result = (fromValue - 32) * 5/9;
                    } else if (toUnit === 'kelvin') {
                        result = (fromValue - 32) * 5/9 + 273.15;
                    }
                }
                // Kelvin to ...
                else if (fromUnit === 'kelvin') {
                    if (toUnit === 'celsius') {
                        result = fromValue - 273.15;
                    } else if (toUnit === 'fahrenheit') {
                        result = (fromValue - 273.15) * 9/5 + 32;
                    }
                }
            } 
            // Standard conversion for other categories
            else {
                const fromFactor = unitData.units[fromUnit].factor;
                const toFactor = unitData.units[toUnit].factor;
                
                // Convert 'from' value to base unit, then to 'to' unit
                const valueInBaseUnit = fromValue * fromFactor;
                result = valueInBaseUnit / toFactor;
            }

            // Display the result, rounded to a reasonable number of decimal places
            toValueInput.value = parseFloat(result.toFixed(6));
        }

        // Function to swap units
        function swapUnits() {
            const fromUnit = fromUnitSelect.value;
            fromUnitSelect.value = toUnitSelect.value;
            toUnitSelect.value = fromUnit;

            // Also swap values
            const fromValue = fromValueInput.value;
            fromValueInput.value = toValueInput.value;
            // toValueInput.value = fromValue; // This feels weird, let's just recalculate
            
            convert();
        }

        // --- Event Listeners ---
        
        // When category changes, update unit dropdowns
        categorySelect.addEventListener('change', populateUnits);
        
        // When input value or units change, recalculate
        fromValueInput.addEventListener('input', convert);
        fromUnitSelect.addEventListener('change', convert);
        toUnitSelect.addEventListener('change', convert);
        
        // When swap button is clicked
        swapButton.addEventListener('click', swapUnits);
        
        // --- Add new event listener ---
        geminiButton.addEventListener('click', handleGeminiClick);
        // --- End of new listener ---


        // --- Initial Load ---
        populateUnits();


        // --- ✨ Gemini API Functions ---

        const apiKey = ""; // API key will be provided by the environment

        // Helper to sleep for exponential backoff
        const sleep = (ms) => new Promise(res => setTimeout(res, ms));

        /**
         * Calls the Gemini API with exponential backoff.
         * @param {string} prompt The prompt to send to the model.
         * @returns {Promise<string|null>} The generated text or null if failed.
         */
        async function callGeminiAPI(prompt) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: {
                    parts: [{ text: "You are a helpful assistant. Your goal is to provide a single, simple, real-world comparison or context for a unit conversion. Be concise (1-2 sentences) and creative. Make it easy for anyone to understand." }]
                }
            };

            let retries = 3;
            let delay = 1000; // 1 second

            while (retries > 0) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        // Handle potential variations in the response structure
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (text) {
                            return text;
                        } else {
                            console.error("Gemini API Error: No text in response", result);
                            return "Sorry, I received an unusual response. Please try again.";
                        }
                    } else {
                        const errorText = await response.text();
                        console.error("Gemini API Error: Response not OK", response.status, errorText);
                        // Don't retry on client errors (4xx)
                        if (response.status >= 400 && response.status < 500) {
                            return "Sorry, there was a problem with the request. (Error " + response.status + ")";
                        }
                        // Retry on server errors (5xx) or network issues
                    }
                } catch (error) {
                    console.error("Gemini API Error: Fetch failed", error);
                }

                retries--;
                if (retries > 0) {
                    // Don't log retries to the console as errors
                    await sleep(delay);
                    delay *= 2; // Exponential backoff
                }
            }

            return "Sorry, I'm having trouble connecting. Please try again later.";
        }

        /**
         * Handles the click event for the Gemini context button.
         */
        async function handleGeminiClick() {
            // 1. Set loading state
            geminiButton.disabled = true;
            geminiButtonText.textContent = "Thinking...";
            sparkleIcon.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            geminiResultContainer.classList.add('hidden');

            // 2. Get values and build prompt
            const fromValue = fromValueInput.value;
            const toValue = toValueInput.value;
            const fromUnitText = fromUnitSelect.options[fromUnitSelect.selectedIndex].text;
            const toUnitText = toUnitSelect.options[toUnitSelect.selectedIndex].text;
            
            // Check for valid numbers
            if (isNaN(parseFloat(fromValue)) || isNaN(parseFloat(toValue))) {
                 geminiResultText.textContent = "Please enter a valid number to convert first.";
                 geminiResultContainer.classList.remove('hidden');
                 // Reset button
                 geminiButton.disabled = false;
                 geminiButtonText.textContent = "✨ Get Real-World Context";
                 sparkleIcon.classList.remove('hidden');
                 loadingSpinner.classList.add('hidden');
                 return;
            }

            const prompt = `Give me a simple, one-sentence real-world comparison for ${fromValue} ${fromUnitText} (which is about ${toValue} ${toUnitText}). Keep it concise and easy to understand.`;

            // 3. Call API
            const resultText = await callGeminiAPI(prompt);

            // 4. Display result
            geminiResultText.textContent = resultText;
            geminiResultContainer.classList.remove('hidden');

            // 5. Reset button state
            geminiButton.disabled = false;
            geminiButtonText.textContent = "✨ Get Real-World Context";
            sparkleIcon.classList.remove('hidden');
            loadingSpinner.classList.add('hidden');
        }
        // --- End of Gemini API Functions ---

    </script>
</body>
</html>